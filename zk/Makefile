IMAGE ?= veilcast-zk
CIRCUIT ?= circuits/example
WORKDIR := /workspace
DOCKER_RUN := docker run --rm -it -v $(PWD):$(WORKDIR) $(IMAGE)

.PHONY: build shell new check prove verify clean

build:
	docker build -t $(IMAGE) .

shell: build
	$(DOCKER_RUN) bash

# Create a new circuit scaffold (default path: zk/$(CIRCUIT))
new: build
	$(DOCKER_RUN) nargo new $(CIRCUIT)

# Run `nargo check` inside the circuit directory
check: build
	$(DOCKER_RUN) bash -lc "cd $(CIRCUIT) && nargo check"

# Generate proof; nargo will place artifacts under proofs/ by default
prove: build
	$(DOCKER_RUN) bash -lc "cd $(CIRCUIT) && nargo prove $(notdir $(CIRCUIT))"

# Verify proof generated by `prove`
verify: build
	$(DOCKER_RUN) bash -lc "cd $(CIRCUIT) && nargo verify $(notdir $(CIRCUIT))"

# Clean build artifacts
clean:
	rm -rf $(CIRCUIT)/target $(CIRCUIT)/proofs $(CIRCUIT)/Prover.toml $(CIRCUIT)/Verifier.toml
